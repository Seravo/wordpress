# Docker Compose for Seravo WordPress project template
#
# To start, simply run:
#   SITE=example docker-compose up
#
# Clean up:
#   docker-compose down -v --remove-orphans
#   rm -rf .vagrant
#
version: '3'

services:
  wordpress:
    container_name: ${SITE:-wordpress}
    hostname: ${SITE:-wordpress}
    domainname: ${SITE:-wordpress}
    image: seravo/wordpress:development
    volumes:
      - wp-data:/data
      - .:/data/wordpress
    entrypoint: /sbin/swd_init
    labels:
      - traefik.enable=true # Traefik is configured with these labels
      - traefik.http.routers.wp.rule=Host(`${SITE:-wordpress}.localhost`)
      - traefik.http.routers.wp.entrypoints=web # route http
      - traefik.http.routers.wps.rule=Host(`${SITE:-wordpress}.localhost`)
      - traefik.http.routers.wps.entrypoints=websecure # route https
      - traefik.http.routers.wps.tls=true # enable https
      - traefik.tcp.routers.wph.rule=HostSNI(`*`) # SSH does not support SNI, thus route all traffic at port 22
      - traefik.tcp.routers.wph.entrypoints=ssh
      - traefik.tcp.routers.wph.service=wphs
      - traefik.tcp.services.wphs.loadbalancer.server.port=22
      - traefik.http.services.wp.loadbalancer.server.port=80
    environment:
      - WP_USER_UID=${WP_USER_UID}
      - DEBUG=${DEBUG}
    networks:
      - traefik-net

  traefik:
    container_name: traefik
    image: traefik:v2.3
    command:
      - --log.level=debug # Be verbose
      - --api.insecure=true # Allow Traefik itself to run on http (not https)
      - --providers.docker
      - --entrypoints.ssh.address=:22
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --serverstransport.insecureskipverify=true # Allow self-signed certs in routed traffic (=Seravo Docker image)
    ports:
      - 22:22
      - 80:80
      - 443:443
      - 8080:8080
      - 8989:8989
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - traefik-net

networks:
  traefik-net:
    external: true
  # The network must be external so that other containers can run as well, that
  # is the whole point in pursuing Docker based dev environements
  # Users will however need to run 'docker network create traefik-net' themselves,
  # but that is OK as Docker automatically instructs to do so

volumes:
  wp-data:
